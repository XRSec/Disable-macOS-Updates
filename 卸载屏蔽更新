#!/bin/bash

if [[ $EUID -ne 0 ]]; then
    echo "此脚本需要管理员权限才能运行"
    printf "请输入您的管理员密码："
    
    # 循环验证密码，最多尝试3次
    for attempt in {1..3}; do
        read password
        echo
        
        # 使用echo和sudo验证密码
        if echo "$password" | sudo -S true 2>/dev/null; then
            echo "密码验证成功！"
            # 将密码传递给sudo命令
            echo "$password" | sudo -S /bin/bash "$0" "$@"
            exit $?
        else
            if [ $attempt -lt 3 ]; then
                printf "密码错误，再试一次："
            else
                echo "密码错误次数过多，退出程序"
                exit 1
            fi
        fi
    done
fi

cd "$( dirname "${BASH_SOURCE[0]}" )"

sudo mount -uw / 2>/dev/null
killall Finder

echo "开始卸载屏蔽更新..."

# 手动清理屏蔽条目
hosts_entries=(
    "appldnld.apple.com"
    "gg.apple.com"
    "gnf-mdn.apple.com"
    "gnf-mr.apple.com"
    "gs.apple.com"
    "ig.apple.com"
    "mesu.apple.com"
    "ns.itunes.apple.com"
    "oscdn.apple.com"
    "osrecovery.apple.com"
    "skl.apple.com"
    "swcdn.apple.com"
    "swdist.apple.com"
    "swdownload.apple.com"
    "swpost.apple.com"
    "swquery.apple.com"
    "swscan.apple.com"
    "updates-http.cdn-apple.com"
    "updates.cdn-apple.com"
    "xp.apple.com"
)

# 创建临时文件
temp_hosts=$(mktemp)

# 复制原hosts文件，但排除屏蔽条目
while IFS= read -r line; do
    should_keep=true
    for domain in "${hosts_entries[@]}"; do
        if [[ "$line" == *"$domain"* ]]; then
            should_keep=false
            echo "移除屏蔽条目: $domain"
            break
        fi
    done
    if [ "$should_keep" = true ]; then
        echo "$line" >> "$temp_hosts"
    fi
done < /private/etc/hosts

# 替换原hosts文件
sudo cp "$temp_hosts" /private/etc/hosts
rm -f "$temp_hosts"

echo "屏蔽条目清理完成"

echo
echo "卸载屏蔽macOS更新完成！"
echo "Enjoy! Tools By XRSec！"
echo
exit 0
