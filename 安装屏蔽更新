#!/bin/bash

if [[ $EUID -ne 0 ]]; then
    echo "此脚本需要管理员权限才能运行"
    printf "请输入您的管理员密码："
    
    # 循环验证密码，最多尝试3次
    for attempt in {1..3}; do
        read password
        echo
        
        # 使用echo和sudo验证密码
        if echo "$password" | sudo -S true 2>/dev/null; then
            echo "密码验证成功！"
            # 将密码传递给sudo命令
            echo "$password" | sudo -S /bin/bash "$0" "$@"
            exit $?
        else
            if [ $attempt -lt 3 ]; then
                printf "密码错误，再试一次："
            else
                echo "密码错误次数过多，退出程序"
                exit 1
            fi
        fi
    done
fi

cd "$( dirname "${BASH_SOURCE[0]}" )"

sudo mount -uw / 2>/dev/null
killall Finder

sudo cp /private/etc/hosts /private/etc/hosts_Disable-macOS-Updates
echo "备份文件：/private/etc/hosts_Disable-macOS-Updates"

echo "开始安装屏蔽更新..."

# 内置的hosts条目
hosts_entries=(
    "127.0.0.1	appldnld.apple.com      # Disable-macOS-Updates"
    "127.0.0.1	gg.apple.com        # Disable-macOS-Updates"
    "127.0.0.1	gnf-mdn.apple.com   # Disable-macOS-Updates"
    "127.0.0.1	gnf-mr.apple.com    # Disable-macOS-Updates"
    "127.0.0.1	gs.apple.com    # Disable-macOS-Updates"
    "127.0.0.1	ig.apple.com    # Disable-macOS-Updates"
    "127.0.0.1	mesu.apple.com  # Disable-macOS-Updates"
    "127.0.0.1	ns.itunes.apple.com # Disable-macOS-Updates"
    "127.0.0.1	oscdn.apple.com # Disable-macOS-Updates"
    "127.0.0.1	osrecovery.apple.com    # Disable-macOS-Updates"
    "127.0.0.1	skl.apple.com   # Disable-macOS-Updates"
    "127.0.0.1	swcdn.apple.com # Disable-macOS-Updates"
    "127.0.0.1	swdist.apple.com    # Disable-macOS-Updates"
    "127.0.0.1	swdownload.apple.com    # Disable-macOS-Updates"
    "127.0.0.1	swpost.apple.com    # Disable-macOS-Updates"
    "127.0.0.1	swquery.apple.com   # Disable-macOS-Updates"
    "127.0.0.1	swscan.apple.com    # Disable-macOS-Updates"
    "127.0.0.1	updates-http.cdn-apple.com  # Disable-macOS-Updates"
    "127.0.0.1	updates.cdn-apple.com   # Disable-macOS-Updates"
    "127.0.0.1	xp.apple.com    # Disable-macOS-Updates"
)

# 遍历hosts条目数组并添加到系统hosts文件
for entry in "${hosts_entries[@]}"; do
    # 提取域名部分（去掉IP地址和注释）
    domain=$(echo "$entry" | awk '{print $2}')
    
    if [ -n "$domain" ]; then
        # 检查域名是否已存在于系统hosts文件中
        if ! grep -q "$domain" /private/etc/hosts; then
            echo "添加: $domain"
            echo "$entry" | sudo tee -a /private/etc/hosts > /dev/null
        else
            echo "跳过已存在的条目: $domain"
        fi
    fi
done

echo
echo "屏蔽macOS更新完成！"
echo "Enjoy! Tools By XRSec！"
echo
exit 0
